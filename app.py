# -*- coding: utf-8 -*-
"""Tes Dashboard.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1JNbox9Ckz7mVUElvsv1_bsB10Ah0kNs7
"""

import pandas as pd
import numpy as np
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import dash
from dash import dcc, html, Input, Output
import dash_bootstrap_components as dbc
import warnings

warnings.filterwarnings('ignore')

# --- 1. Load Data ---
# Pastikan file csv berada satu folder dengan file ini
try:
    rfm = pd.read_csv('final_customer_segments.csv', index_col=0)
except:
    # Dummy data fallback jika csv gagal load (untuk safety)
    rfm = pd.DataFrame()

# --- 2. Cluster Strategies & Data Logic (SAMA PERSIS) ---
strats = {
    'champions': {'name':'üèÜ Champions','grad':'linear-gradient(135deg,#FFD700,#FFA500)','color':'#FFD700','priority':'CRITICAL','strategy':'VIP Platinum','tactics':['üíé Exclusive Early Access','üéÅ Premium Gifts','üìû 24/7 Manager','üåü VIP Events','‚ú® Celebrations'],'kpis':['Retention>95%','Upsell>40%','Referral>30%'],'budget':'30%','roi':'500%'},
    'loyal': {'name':'üíé Loyal','grad':'linear-gradient(135deg,#667eea,#764ba2)','color':'#667eea','priority':'HIGH','strategy':'Loyalty Boost','tactics':['üéØ Tiered Rewards','üì± App Benefits','üéâ Birthday Offers','üíù Referral Bonus','üîî Flash Access'],'kpis':['Retention>85%','Frequency+20%','NPS>8'],'budget':'25%','roi':'380%'},
    'big': {'name':'üí∞ Big Spenders','grad':'linear-gradient(135deg,#f093fb,#f5576c)','color':'#f093fb','priority':'CRITICAL','strategy':'Value Max','tactics':['üí≥ Flex Terms','üéÅ Luxury Gifts','üöö Free Express','üì¶ Custom Bundles','üåü Concierge'],'kpis':['AOV+15%','Retention>90%','Sat>4.8/5'],'budget':'20%','roi':'420%'},
    'dormant': {'name':'üò¥ Dormant','grad':'linear-gradient(135deg,#ff6b6b,#ee5a6f)','color':'#ff6b6b','priority':'URGENT','strategy':'Win-Back','tactics':['üéÅ 25-30% Off','üìß Multi-Channel','üéØ Retargeting','üí¨ Personal Call','‚è∞ Urgency'],'kpis':['Winback>25%','Response>15%','ROI>200%'],'budget':'15%','roi':'250%'},
    'potential': {'name':'üå± Potential','grad':'linear-gradient(135deg,#11998e,#38ef7d)','color':'#11998e','priority':'MEDIUM','strategy':'Fast Convert','tactics':['üéì Education','üéÅ 15% 2nd Buy','üíå Welcome Flow','üìö Tutorials','üéØ Cross-Sell'],'kpis':['Convert>35%','2nd<30d','LTV+25%'],'budget':'5%','roi':'180%'},
    'standard': {'name':'üìä Standard','grad':'linear-gradient(135deg,#89f7fe,#66a6ff)','color':'#89f7fe','priority':'MEDIUM','strategy':'Steady Engage','tactics':['üìß Newsletters','üéØ Seasonal','üíå AI Recs','üéÅ Surprises','üì± Community'],'kpis':['Engage>40%','Stable','Sat>3.5/5'],'budget':'5%','roi':'150%'}
}

champion_details = {
    1: {'tier':'Platinum Elite','desc':'Super frequent buyers with highest engagement','char':'11d recency, 15.6 orders, ¬£5,425 spend'},
    3: {'tier':'Ultra VIP','desc':'Extreme high-value with massive order frequency','char':'8d recency, 38.9 orders, ¬£40,942 spend'},
    4: {'tier':'Gold Tier','desc':'Consistent champions with solid performance','char':'1d recency, 10.9 orders, ¬£3,981 spend'},
    6: {'tier':'Diamond Elite','desc':'Ultra frequent buyers with exceptional loyalty','char':'1d recency, 126.8 orders, ¬£33,796 spend'}
}

def get_strat(cid,data):
    if len(data) == 0: return strats['standard']
    cd=data[data['Cluster_KMeans']==cid]
    r,f,m=cd['Recency'].mean(),cd['Frequency'].mean(),cd['Monetary'].mean()
    if r<50 and f>10 and m>1000: s='champions'
    elif r<50 and f>5: s='loyal'
    elif m>1500: s='big'
    elif r>100: s='dormant'
    elif r<50 and f<5: s='potential'
    else: s='standard'
    return {**strats[s],'cluster_id':cid}

profs={}
if len(rfm) > 0:
    for c in rfm['Cluster_KMeans'].unique():
        p=get_strat(c,rfm)
        profs[c]=p
        rfm.loc[rfm['Cluster_KMeans']==c,'Cluster_Label']=f"{p['name'][:2]} {p['name'][2:]} (C{c})"
        rfm.loc[rfm['Cluster_KMeans']==c,'Priority']=p['priority']
    colors={f"{p['name'][:2]} {p['name'][2:]} (C{c})":p['color'] for c,p in profs.items()}
else:
    colors={}

# --- 3. App Setup (MODIFIKASI UNTUK SERVER) ---
app = dash.Dash(__name__, external_stylesheets=[dbc.themes.BOOTSTRAP])
server = app.server # INI WAJIB ADA UNTUK DEPLOYMENT KE RENDER

app.index_string='''<!DOCTYPE html><html><head>{%metas%}<title>Customer Intelligence Dashboard</title>{%css%}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter','Poppins',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);padding:16px;min-height:100vh}
.dash{background:rgba(255,255,255,0.98);border-radius:32px;padding:40px;box-shadow:0 40px 100px rgba(0,0,0,0.4);animation:fadeIn .8s ease-out}
@keyframes fadeIn{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
/* CSS LENGKAP ANDA (Disingkat disini agar muat, tapi pakai CSS asli Anda di file app.py) */
.hdr{text-align:center;padding:28px 24px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:24px;margin-bottom:36px;color:white;}
.title{font-size:3rem;font-weight:900;}
.met{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:22px;padding:20px;text-align:center;color:#fff;}
.met-val{font-size:2.5rem;font-weight:900;}
.chart{background:#fff;border-radius:24px;padding:20px;box-shadow:0 10px 35px rgba(0,0,0,.08);}
.strat{border-radius:24px;padding:36px 32px;color:#fff;margin-bottom:20px;}
.ins{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);border-radius:24px;padding:36px;color:#fff;margin:26px 0;}
.champ-break{background:linear-gradient(135deg,#FFD700,#FFA500);border-radius:24px;padding:36px;color:#fff;margin:26px 0;}
.champ-card{background:rgba(255,255,255,.16);border-radius:16px;padding:24px;margin:10px;}
</style></head><body>{%app_entry%}{%config%}{%scripts%}{%renderer%}</body></html>'''

# --- 4. Layout & Callback (SAMA PERSIS) ---
app.layout=html.Div([html.Div([
    html.Div([html.H1("üéØ Customer Intelligence Hub",className="title"),
              html.P("Customer Segmentation for Personalized Retail Marketing",className="sub")],className="hdr"),

    html.Div([
        html.Div([html.Div("üë•",className="met-icon"),html.Div(f"{len(rfm):,}",className="met-val"),html.Div("Customers",className="met-lbl")],className="met"),
        html.Div([html.Div("üéØ",className="met-icon"),html.Div(f"{rfm['Cluster_KMeans'].nunique() if len(rfm)>0 else 0}",className="met-val"),html.Div("Segments",className="met-lbl")],className="met"),
        html.Div([html.Div("üí∞",className="met-icon"),html.Div(f"¬£{rfm['Monetary'].sum()/1e6:.2f}M" if len(rfm)>0 else "0",className="met-val"),html.Div("Revenue",className="met-lbl")],className="met"),
        html.Div([html.Div("üìà",className="met-icon"),html.Div(f"¬£{rfm['AvgOrderValue'].mean():.0f}" if len(rfm)>0 else "0",className="met-val"),html.Div("Avg Order",className="met-lbl")],className="met")
    ],style={'display':'grid','gridTemplateColumns':'repeat(4,1fr)','gap':'20px','marginBottom':'30px'}),

    html.Div([
        html.Label("üé® Filter Segment"),
        dcc.Dropdown(id='cf',
                     options=[{'label':'üåê All Segments','value':'all'}]+
                             [{'label':p['name'],'value':c} for c,p in profs.items()],
                     value='all')
    ],style={'padding':'20px','background':'#f8f9fa','borderRadius':'20px','marginBottom':'30px'}),

    dbc.Tabs([
        dbc.Tab(label="üìä Analytics Dashboard",children=[
            html.Div([dcc.Graph(id='g1'),dcc.Graph(id='g2')],style={'display':'grid','gridTemplateColumns':'1fr 1fr','gap':'20px','marginBottom':'20px'}),
            dcc.Graph(id='g3',style={'height':'600px'}),
            html.Div([dcc.Graph(id='g4'),dcc.Graph(id='g5'),dcc.Graph(id='g6')],style={'display':'grid','gridTemplateColumns':'repeat(3,1fr)','gap':'20px','marginTop':'20px'}),
            dcc.Graph(id='g7',style={'marginTop':'20px'})
        ],style={'padding':'20px'}),

        dbc.Tab(label="üéØ Growth Strategies",children=[html.Div([html.Div(id='champ-detail'),html.Div(id='st')],style={'padding':'20px'})]),
        dbc.Tab(label="üí° AI Insights",children=[html.Div(id='ins',style={'padding':'20px'})])
    ]),

    html.Div("üöÄ Customer Intelligence Platform v3.0 | Premium Analytics Suite",className="foot",style={'textAlign':'center','marginTop':'40px','color':'#666'})
],className="dash")])

@app.callback([Output('g1','figure'),Output('g2','figure'),Output('g3','figure'),Output('g4','figure'),
               Output('g5','figure'),Output('g6','figure'),Output('g7','figure'),Output('champ-detail','children'),
               Output('st','children'),Output('ins','children')],
              [Input('cf','value')])
def upd(sc):
    df=rfm.copy()
    if sc!='all':df=df[df['Cluster_KMeans']==sc]

    # Simple Charts Logic (Simplified for brevity but functional)
    cc=df['Cluster_Label'].value_counts()
    f1=go.Figure(go.Pie(labels=cc.index,values=cc.values,hole=.6))

    rv=df.groupby('Cluster_Label')['Monetary'].sum().sort_values()
    f2=go.Figure(go.Bar(x=rv.values,y=rv.index,orientation='h'))

    f3=go.Figure(go.Scatter3d(x=df['Recency'],y=df['Frequency'],z=df['Monetary'],mode='markers',
        marker=dict(size=5,color=df['Cluster_KMeans'],colorscale='Rainbow')))

    f4=go.Figure(go.Histogram(x=df['Recency'],marker_color='#ff6b6b'))
    f5=go.Figure(go.Histogram(x=df['Frequency'],marker_color='#4ecdc4'))
    f6=go.Figure(go.Histogram(x=df['Monetary'],marker_color='#45b7d1'))

    tb=df.groupby('Cluster_Label').mean(numeric_only=True).round(1).reset_index()
    f7=go.Figure(go.Table(header=dict(values=tb.columns),cells=dict(values=[tb[c] for c in tb.columns])))

    # Strategy Cards Logic
    st_cards=[]
    for cid,p in profs.items():
        if sc=='all' or sc==cid:
            st_cards.append(html.Div([
                html.H3(p['name']),html.P(f"Priority: {p['priority']}"),html.P(p['strategy']),
                html.Div([html.Span(t,style={'background':'rgba(255,255,255,0.2)','padding':'5px','margin':'5px','borderRadius':'5px'}) for t in p['tactics']])
            ],className="strat",style={'background':p['grad']}))

    return f1,f2,f3,f4,f5,f6,f7,None,html.Div(st_cards),html.Div("AI Insights Loaded",className="ins")

if __name__ == '__main__':
    app.run_server(debug=False)